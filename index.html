<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pencatatan Usaha Batagor - Neumorphism</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --neumorph-bg: #eef0f4;
            --neumorph-shadow-light: #ffffff;
            --neumorph-shadow-dark: #d1d9e6;
            --neumorph-radius-sm: 8px;
            --neumorph-radius-md: 15px;
            --neumorph-radius-lg: 20px;
            --neumorph-text-color: #5c677b;
            --neumorph-text-light: #8693a8;
            --neumorph-accent-color: #3b82f6; /* Blue */
            --neumorph-accent-color-dark: #2563eb;
            --neumorph-green: #10b981;
            --neumorph-red: #ef4444;
            --neumorph-yellow: #f59e0b;
            --neumorph-teal: #14b8a6;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--neumorph-bg);
            color: var(--neumorph-text-color);
        }

        .neumorph-container {
            background-color: var(--neumorph-bg);
            border-radius: var(--neumorph-radius-lg);
            padding: 2rem; /* p-8 */
            box-shadow: 10px 10px 20px var(--neumorph-shadow-dark), -10px -10px 20px var(--neumorph-shadow-light);
        }

        .neumorph-card {
            background-color: var(--neumorph-bg);
            border-radius: var(--neumorph-radius-md);
            padding: 1.5rem; /* p-6 */
            box-shadow: 6px 6px 12px var(--neumorph-shadow-dark), -6px -6px 12px var(--neumorph-shadow-light);
            transition: all 0.3s ease-in-out;
        }
        .neumorph-card:hover {
            box-shadow: 8px 8px 16px var(--neumorph-shadow-dark), -8px -8px 16px var(--neumorph-shadow-light),
                        inset 2px 2px 4px var(--neumorph-shadow-dark), inset -2px -2px 4px var(--neumorph-shadow-light);
        }

        .neumorph-input,
        .neumorph-select {
            background-color: var(--neumorph-bg);
            border-radius: var(--neumorph-radius-sm);
            border: none;
            padding: 0.75rem 1rem; /* p-3 px-4 */
            box-shadow: inset 4px 4px 8px var(--neumorph-shadow-dark), inset -4px -4px 8px var(--neumorph-shadow-light);
            color: var(--neumorph-text-color);
            width: 100%;
            transition: box-shadow 0.2s ease;
        }
        .neumorph-input::placeholder {
            color: var(--neumorph-text-light);
        }
        .neumorph-input:focus,
        .neumorph-select:focus {
            outline: none;
            box-shadow: inset 6px 6px 12px var(--neumorph-shadow-dark), inset -6px -6px 12px var(--neumorph-shadow-light),
                        2px 2px 4px var(--neumorph-shadow-dark), -2px -2px 4px var(--neumorph-shadow-light); /* Slight outer glow on focus */
        }

        .neumorph-button {
            background-color: var(--neumorph-bg);
            border-radius: var(--neumorph-radius-sm);
            padding: 0.75rem 1.5rem; /* py-3 px-6 */
            color: var(--neumorph-text-color);
            font-weight: 500;
            box-shadow: 5px 5px 10px var(--neumorph-shadow-dark), -5px -5px 10px var(--neumorph-shadow-light);
            transition: all 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
        }
        .neumorph-button:hover {
            color: var(--neumorph-accent-color);
            box-shadow: 6px 6px 12px var(--neumorph-shadow-dark), -6px -6px 12px var(--neumorph-shadow-light);
        }
        .neumorph-button:active, .neumorph-button.active {
            box-shadow: inset 5px 5px 10px var(--neumorph-shadow-dark), inset -5px -5px 10px var(--neumorph-shadow-light);
            color: var(--neumorph-accent-color-dark);
        }
        .neumorph-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            box-shadow: inset 3px 3px 6px var(--neumorph-shadow-dark), inset -3px -3px 6px var(--neumorph-shadow-light);
        }
        .neumorph-button i {
            margin-right: 0.5rem;
        }

        /* Button specific colors */
        .neumorph-button.btn-primary { color: var(--neumorph-accent-color); }
        .neumorph-button.btn-primary:hover { color: var(--neumorph-accent-color-dark); }
        .neumorph-button.btn-primary:active { color: var(--neumorph-accent-color-dark); }

        .neumorph-button.btn-red { color: var(--neumorph-red); }
        .neumorph-button.btn-red:hover { color: #c13030; }
        .neumorph-button.btn-red:active { color: #c13030; }
        
        .neumorph-button.btn-green { color: var(--neumorph-green); }
        .neumorph-button.btn-green:hover { color: #0d9264; }
        .neumorph-button.btn-green:active { color: #0d9264; }

        .neumorph-button.btn-purple { color: #8b5cf6; }
        .neumorph-button.btn-purple:hover { color: #7c3aed; }
        .neumorph-button.btn-purple:active { color: #7c3aed; }


        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .modal {
            display: none; position: fixed; z-index: 100;
            left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.4); /* Darker overlay for contrast */
            padding-top: 130px;
        }
        .modal-content {
            background-color: var(--neumorph-bg);
            margin: 5% auto; padding: 25px;
            border: none; width: 90%; max-width: 550px;
            border-radius: var(--neumorph-radius-md);
            box-shadow: 10px 10px 25px var(--neumorph-shadow-dark), -10px -10px 25px var(--neumorph-shadow-light);
        }
        .close-button {
            color: var(--neumorph-text-light); float: right; font-size: 28px; font-weight: bold;
            transition: color 0.3s ease;
        }
        .close-button:hover, .close-button:focus {
            color: var(--neumorph-text-color); text-decoration: none; cursor: pointer;
        }

        .loader {
            border: 4px solid #d1d9e6; /* --neumorph-shadow-dark */
            border-top: 4px solid var(--neumorph-accent-color);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #loadingOverlay .loader {
            width: 60px;
            height: 60px;
            border-top-color: var(--neumorph-accent-color-dark);
        }
        #loadingOverlay p {
            margin-top: 15px;
            font-size: 1.2rem;
            color: var(--neumorph-text-color);
            font-weight: 500;
        }

        .table-container {
            max-height: 450px; 
            overflow-y: auto;
            position: relative; 
            border-radius: var(--neumorph-radius-md);
            background-color: var(--neumorph-bg);
            box-shadow: inset 5px 5px 10px var(--neumorph-shadow-dark), inset -5px -5px 10px var(--neumorph-shadow-light);
            padding: 0.5rem; /* Add some padding inside the inset */
        }
        .table-container thead th {
            position: sticky;
            top: 0;
            z-index: 10; 
            background-color: var(--neumorph-bg); /* Match background for seamless look */
            color: var(--neumorph-text-color);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 0.75rem 1rem;
            /* Subtle bottom border for separation */
            border-bottom: 2px solid var(--neumorph-shadow-dark);
        }
        .table-container tbody tr:hover {
            background-color: #e4e8ed; /* Slightly different shade on hover */
        }
        .table-container td, .table-container th {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #d1d9e640; /* Lighter dividers */
        }
        .table-container tbody tr:last-child td {
            border-bottom: none;
        }

        .chart-container-wrapper { 
            background-color: var(--neumorph-bg);
            padding: 1.5rem;
            border-radius: var(--neumorph-radius-md);
            box-shadow: 6px 6px 12px var(--neumorph-shadow-dark), -6px -6px 12px var(--neumorph-shadow-light);
            margin-bottom: 2rem;
        }
        .chart-container {
            overflow-x: auto; 
            max-width: 100%; 
            position: relative; 
        }
        #transactionLineChart, #bahanBakuPieChart, #bahanHabisPakaiPieChart {
             min-width: 300px; 
        }
        
        .tab-link {
            padding: 0.75rem 1.25rem;
            font-weight: 500;
            color: var(--neumorph-text-light);
            transition: all 0.2s ease;
            border-radius: var(--neumorph-radius-sm);
            margin-right: 0.5rem;
            margin-bottom: 0.5rem; /* For wrapping */
            box-shadow: 4px 4px 8px var(--neumorph-shadow-dark), -4px -4px 8px var(--neumorph-shadow-light);
        }
        .tab-link:hover {
            color: var(--neumorph-accent-color);
        }
        .tab-link.active-tab {
            color: var(--neumorph-accent-color-dark);
            font-weight: 600;
            box-shadow: inset 4px 4px 8px var(--neumorph-shadow-dark), inset -4px -4px 8px var(--neumorph-shadow-light);
        }
        
        .fab {
            position: fixed;
            bottom: 1.5rem; /* Adjusted */
            padding: 1rem; /* Increased padding */
            border-radius: 50%;
            color: var(--neumorph-text-color);
            box-shadow: 6px 6px 12px var(--neumorph-shadow-dark), -6px -6px 12px var(--neumorph-shadow-light);
            transition: all 0.3s ease;
            z-index: 50;
            background-color: var(--neumorph-bg);
            width: 56px; /* Standard FAB size */
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .fab:hover {
            color: var(--neumorph-accent-color);
            transform: translateY(-2px);
            box-shadow: 8px 8px 16px var(--neumorph-shadow-dark), -8px -8px 16px var(--neumorph-shadow-light);
        }
        .fab:active {
            box-shadow: inset 5px 5px 10px var(--neumorph-shadow-dark), inset -5px -5px 10px var(--neumorph-shadow-light);
        }

        #openSettingsButton {
            right: 1.5rem; /* Adjusted */
        }
        #viewSheetLinkButton {
            right: 6.5rem; /* Adjusted */
        }
         /* Colored Summary Cards with Neumorphic Touch */
        .summary-card {
            border-radius: var(--neumorph-radius-md);
            text-align: center;
            color: white; /* Keep text white for colored cards */
            padding: 1.25rem 1rem; /* p-5 p-4 */
            position: relative; /* For pseudo-elements if needed */
            box-shadow: 5px 5px 10px rgba(0,0,0,0.15), /* Softer dark shadow for colored bg */
                        -5px -5px 10px rgba(255,255,255,0.7); /* Lighter highlight */
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }
        .summary-card:hover {
            transform: translateY(-3px);
             box-shadow: 7px 7px 14px rgba(0,0,0,0.2),
                        -7px -7px 14px rgba(255,255,255,0.8);
        }
        .summary-card p:first-child { font-size: 0.875rem; opacity: 0.9; }
        .summary-card p:last-child { font-size: 1.75rem; font-weight: 700; margin-top: 0.25rem; }

        .summary-card.bg-green-neumorph { background-color: var(--neumorph-green); }
        .summary-card.bg-red-neumorph { background-color: var(--neumorph-red); }
        .summary-card.bg-yellow-neumorph { background-color: var(--neumorph-yellow); }
        .summary-card.bg-teal-neumorph { background-color: var(--neumorph-teal); }

        /* PDF Options Container */
        #pdfOptionsContainer {
            background-color: var(--neumorph-bg);
            padding: 1.5rem;
            border-radius: var(--neumorph-radius-md);
            margin-bottom: 1.5rem;
            box-shadow: inset 5px 5px 10px var(--neumorph-shadow-dark), inset -5px -5px 10px var(--neumorph-shadow-light);
        }
        #pdfOptionsContainer h3 {
            font-size: 1.125rem; 
            font-weight: 600; 
            color: var(--neumorph-text-color); 
            margin-bottom: 1rem; 
        }
        #pdfOptionsContainer label {
            display: block;
            margin-bottom: 0.75rem; 
            font-size: 0.875rem; 
            color: var(--neumorph-text-light);
            display: flex;
            align-items: center;
        }
        #pdfOptionsContainer input[type="checkbox"] {
            margin-right: 0.75rem; 
            appearance: none;
            width: 20px;
            height: 20px;
            background-color: var(--neumorph-bg);
            border-radius: 4px;
            box-shadow: inset 2px 2px 4px var(--neumorph-shadow-dark), inset -2px -2px 4px var(--neumorph-shadow-light);
            cursor: pointer;
            position: relative;
            transition: box-shadow 0.2s;
        }
        #pdfOptionsContainer input[type="checkbox"]:checked {
            box-shadow: 2px 2px 4px var(--neumorph-shadow-dark), -2px -2px 4px var(--neumorph-shadow-light);
            background-color: var(--neumorph-accent-color);
        }
        #pdfOptionsContainer input[type="checkbox"]:checked::before {
            content: '\f00c'; /* FontAwesome check icon */
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            color: var(--neumorph-shadow-light); /* White check on accent bg */
            font-size: 12px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        #pdfOptionsContainer input[type="checkbox"]:focus {
            outline: none;
             box-shadow: inset 3px 3px 6px var(--neumorph-shadow-dark), inset -3px -3px 6px var(--neumorph-shadow-light),
                        0 0 0 2px var(--neumorph-accent-color); /* Focus ring */
        }


        /* Title gradient - keep as is or simplify if it clashes too much */
        .title-gradient {
             background-image: linear-gradient(to right, var(--neumorph-accent-color), var(--neumorph-accent-color-dark));
             -webkit-background-clip: text;
             background-clip: text;
             color: transparent;
        }
        
        /* Adjustments for text color on dark backgrounds (e.g. sheet send status) */
        .status-message-neumorph {
            padding: 1rem;
            border-radius: var(--neumorph-radius-md);
            text-align: center;
            font-size: 0.875rem; /* text-sm */
            box-shadow: 5px 5px 10px var(--neumorph-shadow-dark), -5px -5px 10px var(--neumorph-shadow-light);
            margin-bottom: 1.5rem;
        }
        .status-message-neumorph.success { background-color: #d1fae5; color: #065f46; } /* green-100, green-800 */
        .status-message-neumorph.error { background-color: #fee2e2; color: #991b1b; } /* red-100, red-800 */
        .status-message-neumorph.pending { background-color: #fef3c7; color: #92400e; } /* yellow-100, yellow-800 */
        .status-message-neumorph.info { background-color: #dbeafe; color: #1e40af; } /* blue-100, blue-800 */


    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden fixed top-0 left-0 w-full h-full bg-white/80 flex items-center justify-center z-[200]" style="background-color: rgba(238, 240, 244, 0.8);">
        <div class="text-center">
            <div class="loader"></div>
            <p>Memuat data dari Spreadsheet...</p>
        </div>
    </div>

    <!-- Main Application Container -->
    <div class="container mx-auto max-w-6xl neumorph-container">
        <header class="mb-10 text-center">
            <h1 class="text-4xl font-bold title-gradient">
                <i class="fas fa-store mr-2"></i>Pencatatan Usaha Batagor
            </h1>
            <p class="text-gray-500 mt-2 text-lg" style="color: var(--neumorph-text-light);">pengelolaan keuangan cabang contong</p>
        </header>

        <!-- Tabs Navigation -->
        <div class="mb-8">
            <ul class="flex flex-wrap -mb-px text-sm font-medium text-center" id="tabs-nav">
                <li class="mr-2 mb-2">
                    <a href="#" class="tab-link active-tab" data-tab="pengeluaran"><i class="fas fa-receipt mr-1"></i>Pengeluaran</a>
                </li>
                <li class="mr-2 mb-2">
                    <a href="#" class="tab-link" data-tab="pemasukan"><i class="fas fa-hand-holding-usd mr-1"></i>Pemasukan</a>
                </li>
                <li class="mr-2 mb-2"> 
                    <a href="#" class="tab-link" data-tab="grafikContainerTab"><i class="fas fa-chart-pie mr-1"></i>Grafik Ringkasan</a>
                </li>
            </ul>
        </div>

        <!-- Tab Content Area -->
        <div id="tab-content-container">
            <!-- Pengeluaran Tab -->
            <div id="pengeluaran" class="tab-content active neumorph-card space-y-6 mb-8">
                <h2 class="text-2xl font-semibold mb-4 flex items-center" style="color: var(--neumorph-red);"><i class="fas fa-minus-circle mr-2"></i>Input Pengeluaran</h2>
                <form id="formPengeluaran" class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5">
                    <div>
                        <label for="tanggalPengeluaran" class="block text-sm font-medium mb-1" style="color: var(--neumorph-text-color);">Tanggal:</label>
                        <input type="date" id="tanggalPengeluaran" class="neumorph-input mt-1 block w-full" required>
                    </div>
                    <div>
                        <label for="deskripsiPengeluaran" class="block text-sm font-medium mb-1" style="color: var(--neumorph-text-color);">Deskripsi Barang:</label>
                        <select id="deskripsiPengeluaran" class="neumorph-select mt-1 block w-full" required>
                            <option value="">-- Pilih Barang --</option>
                        </select>
                    </div>
                    <div>
                        <label for="kuantitasPengeluaran" class="block text-sm font-medium mb-1" style="color: var(--neumorph-text-color);">Kuantitas:</label>
                        <input type="number" id="kuantitasPengeluaran" step="any" placeholder="Contoh: 5" class="neumorph-input mt-1 block w-full" required>
                    </div>
                    <div>
                        <label for="satuanPengeluaran" class="block text-sm font-medium mb-1" style="color: var(--neumorph-text-color);">Satuan:</label>
                        <select id="satuanPengeluaran" class="neumorph-select mt-1 block w-full">
                            <option value="pcs">Pcs</option><option value="kg">Kg</option><option value="gram">Gram</option><option value="liter">Liter</option><option value="ml">Ml</option><option value="ikat">Ikat</option><option value="pak">Pak</option><option value="botol">Botol</option><option value="tabung">Tabung</option><option value="lainnya">Lainnya</option>
                        </select>
                    </div>
                    <div>
                        <label for="hargaSatuanPengeluaran" class="block text-sm font-medium mb-1" style="color: var(--neumorph-text-color);">Harga Satuan (Rp):</label>
                        <input type="number" id="hargaSatuanPengeluaran" step="any" placeholder="Contoh: 10000" class="neumorph-input mt-1 block w-full" required>
                    </div>
                    <div>
                        <label for="kategoriPengeluaran" class="block text-sm font-medium mb-1" style="color: var(--neumorph-text-color);">Kategori:</label>
                        <select id="kategoriPengeluaran" class="neumorph-select mt-1 block w-full">
                            <option value="Bahan Baku">Bahan Baku</option><option value="Bahan Habis Pakai">Bahan Habis Pakai</option><option value="Kemasan">Kemasan</option><option value="Operasional">Operasional</option><option value="Transportasi">Transportasi</option><option value="Lainnya">Lainnya</option>
                        </select>
                    </div>
                    <div class="md:col-span-2 mt-3">
                        <button type="submit" id="submitPengeluaran" class="w-full neumorph-button btn-red">
                            <i class="fas fa-plus-circle"></i>
                            <span>Tambah Pengeluaran</span>
                            <span id="loaderPengeluaran" class="loader hidden ml-2"></span>
                        </button>
                    </div>
                </form>
            </div>

            <!-- Pemasukan Tab -->
            <div id="pemasukan" class="tab-content neumorph-card space-y-6 mb-8">
                <h2 class="text-2xl font-semibold mb-4 flex items-center" style="color: var(--neumorph-green);"><i class="fas fa-plus-circle mr-2"></i>Input Pemasukan</h2>
                <form id="formPemasukan" class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5">
                    <div>
                        <label for="tanggalPemasukan" class="block text-sm font-medium mb-1" style="color: var(--neumorph-text-color);">Tanggal:</label>
                        <input type="date" id="tanggalPemasukan" class="neumorph-input mt-1 block w-full" required>
                    </div>
                    <div>
                        <label for="deskripsiPemasukan" class="block text-sm font-medium mb-1" style="color: var(--neumorph-text-color);">Deskripsi Pemasukan:</label>
                        <input type="text" id="deskripsiPemasukan" placeholder="Contoh: Penjualan hari ini" class="neumorph-input mt-1 block w-full" required>
                    </div>
                    <div class="md:col-span-2">
                        <label for="jumlahPemasukan" class="block text-sm font-medium mb-1" style="color: var(--neumorph-text-color);">Jumlah Pemasukan (Rp):</label>
                        <input type="number" id="jumlahPemasukan" step="any" placeholder="Contoh: 500000" class="neumorph-input mt-1 block w-full" required>
                    </div>
                    <div class="md:col-span-2 mt-3">
                         <button type="submit" id="submitPemasukan" class="w-full neumorph-button btn-green">
                            <i class="fas fa-plus-circle"></i>
                            <span>Tambah Pemasukan</span>
                            <span id="loaderPemasukan" class="loader hidden ml-2"></span>
                        </button>
                    </div>
                </form>
            </div>

            <!-- Grafik Tab -->
            <div id="grafikContainerTab" class="tab-content neumorph-card space-y-8 mb-8">
                <section>
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4 text-center" style="color: var(--neumorph-text-color);"><i class="fas fa-chart-line mr-2"></i>Grafik Pemasukan, Pengeluaran, & Saldo</h2>
                     <div class="chart-container-wrapper">
                        <div class="chart-container" style="height:400px;"> <canvas id="transactionLineChart"></canvas> 
                        </div>
                     </div>
                     <p id="lineChartMessage" class="text-center mt-2 hidden" style="color: var(--neumorph-text-light);">Data tidak cukup untuk menampilkan grafik garis.</p>
                </section>

                <section>
                    <h3 class="text-xl font-semibold text-gray-700 mb-3 text-center" style="color: var(--neumorph-text-color);"><i class="fas fa-carrot mr-2"></i>Rincian Pengeluaran Bahan Baku</h3>
                    <div class="chart-container-wrapper" id="bahanBakuChartWrapper">
                        <div class="chart-container" style="height:380px;"> 
                            <canvas id="bahanBakuPieChart"></canvas>
                        </div>
                         <p id="bahanBakuChartMessage" class="text-center mt-2 hidden" style="color: var(--neumorph-text-light);">Tidak ada data pengeluaran bahan baku.</p>
                    </div>
                </section>
                <section>
                    <h3 class="text-xl font-semibold text-gray-700 mb-3 text-center" style="color: var(--neumorph-text-color);"><i class="fas fa-box-open mr-2"></i>Rincian Pengeluaran Bahan Habis Pakai</h3>
                    <div class="chart-container-wrapper" id="bahanHabisPakaiChartWrapper">
                        <div class="chart-container" style="height:380px;"> 
                            <canvas id="bahanHabisPakaiPieChart"></canvas>
                        </div>
                        <p id="bahanHabisPakaiChartMessage" class="text-center mt-2 hidden" style="color: var(--neumorph-text-light);">Tidak ada data pengeluaran bahan habis pakai.</p>
                    </div>
                </section>
            </div>
        </div>

        <!-- Ringkasan Keuangan -->
        <section id="ringkasanKeuanganContainer" class="mb-10 p-6 rounded-xl">
             <h2 class="text-2xl font-semibold mb-5 text-center" style="color: var(--neumorph-text-color);"><i class="fas fa-wallet mr-2"></i>Ringkasan Keuangan</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5">
                <div class="summary-card bg-green-neumorph"><p>Total Pemasukan</p><p id="totalPemasukan">Rp 0</p></div>
                <div class="summary-card bg-red-neumorph"><p>Total Pengeluaran</p><p id="totalPengeluaran">Rp 0</p></div>
                <div class="summary-card bg-yellow-neumorph"><p>Saldo Akhir</p><p id="saldoAkhir">Rp 0</p></div>
                <div class="summary-card bg-teal-neumorph"><p>Margin Keuntungan</p><p id="persentaseKeuntunganValue">N/A</p></div>
            </div>
        </section>

        <!-- Daftar Transaksi -->
        <section id="daftarTransaksiSection" class="mb-10 neumorph-card">
            <h2 class="text-2xl font-semibold mb-4 flex items-center" style="color: var(--neumorph-text-color);"><i class="fas fa-list-alt mr-2"></i>Daftar Transaksi</h2>
             <p class="text-sm mb-3" style="color: var(--neumorph-text-light);">Data dimuat dari Google Sheets dan disimpan sementara. Scroll untuk melihat lebih banyak.</p>
            <div class="table-container">
                <table class="min-w-full divide-y divide-gray-200" style="border-collapse: separate; border-spacing: 0;">
                    <thead> 
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Tanggal</th> <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Jenis</th> <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Deskripsi</th> <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Kuantitas</th> <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Satuan</th> <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Harga Satuan</th> <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Kategori</th> <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Total</th> <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="tabelTransaksi" class="divide-y" style="border-color: #d1d9e640;">
                        <tr><td colspan="9" class="px-4 py-10 text-sm text-center" style="color: var(--neumorph-text-light);">Memuat data atau belum ada transaksi...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>
        
        <!-- Opsi Konten PDF -->
        <section id="pdfOptionsContainer">
            <h3><i class="fas fa-cogs mr-2"></i>Opsi Konten Laporan PDF</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-3">
                <label>
                    <input type="checkbox" id="includeSummaryPdf" checked> Sertakan Ringkasan Keuangan
                </label>
                <label>
                    <input type="checkbox" id="includeLineChartPdf" checked> Sertakan Grafik Transaksi
                </label>
                <label>
                    <input type="checkbox" id="includePieBakuPdf" checked> Sertakan Grafik Bahan Baku
                </label>
                <label>
                    <input type="checkbox" id="includePieHabisPakaiPdf" checked> Sertakan Grafik Bahan Habis Pakai
                </label>
                <label class="sm:col-span-2">
                    <input type="checkbox" id="includeTransactionTablePdf" checked> Sertakan Tabel Daftar Transaksi
                </label>
            </div>
        </section>

        <!-- Action Buttons -->
        <section class="text-center my-10 space-x-0 sm:space-x-4 flex flex-col sm:flex-row justify-center items-center">
            <button id="tombolEkspor" class="neumorph-button btn-primary py-3 px-6 sm:px-8 text-base mb-3 sm:mb-0 w-full sm:w-auto">
                <i class="fas fa-file-download"></i>Unduh Data (CSV)
            </button>
            <button id="tombolUnduhPdf" class="neumorph-button btn-purple py-3 px-6 sm:px-8 text-base w-full sm:w-auto">
                <i class="fas fa-file-pdf"></i> Unduh Laporan (PDF)
            </button>
        </section>
        
        <!-- Sheet Send Status -->
        <div id="sheetSendStatus" class="status-message-neumorph my-6 hidden"></div>

        <!-- Footer -->
        <footer class="mt-16 text-center text-sm pt-6" style="color: var(--neumorph-text-light); border-top: 1px solid var(--neumorph-shadow-dark);">
            <p>&copy; <span id="currentYear"></span> Aplikasi Pencatatan Keuangan Batagor. Dibuat dengan <i class="fas fa-heart" style="color: var(--neumorph-red);"></i>.</p>
        </footer>
    </div>

    <!-- Message Modal -->
    <div id="messageModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h4 id="modalTitle" class="text-lg font-semibold" style="color: var(--neumorph-text-color);">Pemberitahuan</h4>
                <span class="close-button">&times;</span>
            </div>
            <p id="modalMessageText" class="text-base" style="color: var(--neumorph-text-light);"></p>
            <div id="modalActions" class="mt-6 text-right space-x-2">
                <!-- Buttons added by JS -->
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
             <div class="flex justify-between items-center mb-5">
                <h3 class="text-xl font-semibold flex items-center" style="color: var(--neumorph-text-color);"><i class="fas fa-cog mr-2"></i>Pengaturan Google Sheets</h3>
                <span class="close-button" onclick="document.getElementById('settingsModal').style.display='none'">&times;</span>
            </div>
            <div class="space-y-4">
                <div>
                    <label for="appsScriptUrl" class="block text-sm font-medium mb-1" style="color: var(--neumorph-text-color);">URL Web App Google Apps Script:</label>
                    <input type="url" id="appsScriptUrl" class="neumorph-input mt-1 block w-full" placeholder="https://script.google.com/macros/s/...">
                    <p class="mt-1 text-xs" style="color: var(--neumorph-text-light);">URL ini didapatkan setelah deploy Apps Script sebagai Web App.</p>
                </div>
                <div>
                    <label for="googleSheetViewUrl" class="block text-sm font-medium mb-1" style="color: var(--neumorph-text-color);">Link Google Sheet (untuk dilihat langsung):</label>
                    <input type="url" id="googleSheetViewUrl" class="neumorph-input mt-1 block w-full" placeholder="https://docs.google.com/spreadsheets/d/...">
                     <p class="mt-1 text-xs" style="color: var(--neumorph-text-light);">Link spreadsheet Anda untuk akses cepat.</p>
                </div>
                <button onclick="saveSettings()" class="w-full neumorph-button btn-primary">
                    <i class="fas fa-save"></i>Simpan Pengaturan
                </button>
            </div>
            <div id="settingsStatus" class="mt-4 text-sm text-center" style="color: var(--neumorph-text-light);"></div>
        </div>
    </div>

    <!-- Floating Action Buttons -->
    <button id="openSettingsButton" title="Pengaturan Google Sheets" class="fab">
        <i class="fas fa-cog fa-lg"></i>
    </button>
    <a id="viewSheetLinkButton" title="Lihat Google Sheet" href="#" target="_blank" class="fab hidden">
        <i class="fas fa-eye fa-lg"></i>
    </a>

    <script>
        // Daftarkan plugin datalabels secara global
        Chart.register(ChartDataLabels);

        let transactions = [];
        let transactionLineChartInstance = null; 
        let bahanBakuPieChartInstance = null;
        let bahanHabisPakaiPieChartInstance = null;

        const today = new Date().toISOString().split('T')[0];
        const storageKey = 'financialTransactions_v3_neumorph'; 
        const appsScriptUrlKey = 'appsScriptUrl_v3_neumorph';
        const googleSheetViewUrlKey = 'googleSheetViewUrl_v3_neumorph';
        const DEFAULT_APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz1KZ2SuVuS0ivkvRH8p6PKyAuAk7boRA6Beibq4zpYJ1QCiFOud2VXQOIetgoReeXf/exec"; 

        const predefinedExpenses = [
            { name: "Adonan Batagor", category: "Bahan Baku", price: 22500, unit: "kg" },
            { name: "Pangsit", category: "Bahan Baku", price: 12000, unit: "kg" },
            { name: "Bumbu Kacang", category: "Bahan Baku", price: 22500, unit: "kg" },
            { name: "Tahu", category: "Bahan Baku", price: 350, unit: "pcs" },
            { name: "Sambel", category: "Bahan Baku", price: null, unit: "gram" }, 
            { name: "Kecap Paket", category: "Bahan Baku", price: 12000, unit: "pcs" }, 
            { name: "Gas", category: "Bahan Habis Pakai", price: null, unit: "tabung" },
            { name: "Minyak Goreng", category: "Bahan Habis Pakai", price: null, unit: "liter" },
            { name: "Plastik Kemasan", category: "Bahan Habis Pakai", price: null, unit: "pak" },
            { name: "Kecap Eceran", category: "Bahan Habis Pakai", price: null, unit: "pcs" }, 
            { name: "Saos Eceran", category: "Bahan Habis Pakai", price: null, unit: "botol" } 
        ];

        // DOM Elements for PDF Options
        const includeSummaryPdfEl = document.getElementById('includeSummaryPdf');
        const includeLineChartPdfEl = document.getElementById('includeLineChartPdf');
        const includePieBakuPdfEl = document.getElementById('includePieBakuPdf');
        const includePieHabisPakaiPdfEl = document.getElementById('includePieHabisPakaiPdf');
        const includeTransactionTablePdfEl = document.getElementById('includeTransactionTablePdf');

        // DOM Elements
        const formPengeluaran = document.getElementById('formPengeluaran');
        const formPemasukan = document.getElementById('formPemasukan');
        const tabelTransaksi = document.getElementById('tabelTransaksi');
        const tombolEkspor = document.getElementById('tombolEkspor');
        const tombolUnduhPdf = document.getElementById('tombolUnduhPdf'); 
        const totalPemasukanEl = document.getElementById('totalPemasukan');
        const totalPengeluaranEl = document.getElementById('totalPengeluaran');
        const saldoAkhirEl = document.getElementById('saldoAkhir');
        const persentaseKeuntunganValueEl = document.getElementById('persentaseKeuntunganValue');
        const tanggalPengeluaranEl = document.getElementById('tanggalPengeluaran');
        const deskripsiPengeluaranEl = document.getElementById('deskripsiPengeluaran');
        const kuantitasPengeluaranEl = document.getElementById('kuantitasPengeluaran');
        const satuanPengeluaranEl = document.getElementById('satuanPengeluaran');
        const hargaSatuanPengeluaranEl = document.getElementById('hargaSatuanPengeluaran');
        const kategoriPengeluaranEl = document.getElementById('kategoriPengeluaran');
        const tanggalPemasukanEl = document.getElementById('tanggalPemasukan');
        const deskripsiPemasukanEl = document.getElementById('deskripsiPemasukan');
        const jumlahPemasukanEl = document.getElementById('jumlahPemasukan');
        
        const messageModal = document.getElementById('messageModal');
        const modalTitleEl = document.getElementById('modalTitle');
        const modalMessageText = document.getElementById('modalMessageText');
        const modalActionsEl = document.getElementById('modalActions');

        const settingsModal = document.getElementById('settingsModal');
        const appsScriptUrlInput = document.getElementById('appsScriptUrl');
        const googleSheetViewUrlInput = document.getElementById('googleSheetViewUrl');
        const settingsStatusEl = document.getElementById('settingsStatus');
        const openSettingsButton = document.getElementById('openSettingsButton');
        const viewSheetLinkButton = document.getElementById('viewSheetLinkButton');
        const sheetSendStatusEl = document.getElementById('sheetSendStatus');
        const submitPengeluaranBtn = document.getElementById('submitPengeluaran');
        const loaderPengeluaran = document.getElementById('loaderPengeluaran');
        const submitPemasukanBtn = document.getElementById('submitPemasukan');
        const loaderPemasukan = document.getElementById('loaderPemasukan');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const lineChartMessageEl = document.getElementById('lineChartMessage'); 
        
        document.querySelectorAll('.close-button').forEach(btn => {
            btn.onclick = () => { btn.closest('.modal').style.display = 'none'; }
        });
        window.onclick = (event) => {
            if (event.target.classList.contains('modal')) { event.target.style.display = "none"; }
        }
        openSettingsButton.onclick = () => settingsModal.style.display = 'block';

        function saveTransactionsToLocalStorage() {
            try { localStorage.setItem(storageKey, JSON.stringify(transactions)); } 
            catch (e) { console.error("Gagal menyimpan ke Local Storage:", e); showModal("Penyimpanan Lokal Penuh", "Gagal menyimpan data ke penyimpanan lokal browser. Mungkin sudah penuh atau browser tidak mendukung.", "error");}
        }

        function loadTransactionsFromLocalStorage() {
            const storedTransactions = localStorage.getItem(storageKey);
            if (storedTransactions) {
                try { transactions = JSON.parse(storedTransactions); } 
                catch (e) { console.error("Gagal memuat data dari Local Storage:", e); transactions = []; localStorage.removeItem(storageKey); }
            }
        }
        
        function formatRupiah(angka) {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0, maximumFractionDigits:0 }).format(angka || 0);
        }

        function populateDeskripsiPengeluaran() {
            const selectedValue = deskripsiPengeluaranEl.value;
            // Clear existing options except the first placeholder
            while (deskripsiPengeluaranEl.options.length > 1) { deskripsiPengeluaranEl.remove(1); } 
            
            predefinedExpenses.forEach(item => {
                const option = document.createElement('option');
                option.value = item.name; option.textContent = item.name;
                deskripsiPengeluaranEl.appendChild(option);
            });
            // Restore selected value if it's still in the list
            if (predefinedExpenses.some(item => item.name === selectedValue)) {
                deskripsiPengeluaranEl.value = selectedValue;
            } else {
                deskripsiPengeluaranEl.value = ""; // Reset if not found
            }
        }

        deskripsiPengeluaranEl.addEventListener('change', function() {
            const selectedItemName = this.value;
            const selectedItem = predefinedExpenses.find(item => item.name === selectedItemName);
            if (selectedItem) {
                kategoriPengeluaranEl.value = selectedItem.category;
                satuanPengeluaranEl.value = selectedItem.unit; 
                if (selectedItemName === "Sambel" && selectedItem.unit === "gram") {
                    // Kuantitas '1' untuk sambel biasanya berarti 1 porsi/bungkus, harga mungkin beda
                    // Jika harga satuan sambel per gram adalah 45
                    hargaSatuanPengeluaranEl.value = 45; 
                } else {
                    hargaSatuanPengeluaranEl.value = selectedItem.price !== null ? selectedItem.price : '';
                }
                // Auto-focus harga jika kosong dan bukan sambel (yang mungkin butuh input kuantitas dulu)
                if (hargaSatuanPengeluaranEl.value === '' && selectedItemName !== "Sambel") { 
                     hargaSatuanPengeluaranEl.focus();
                }
            } else { 
                // Reset if item not found in predefined list (e.g., custom item typed)
                kategoriPengeluaranEl.value = "Bahan Baku"; // Default category
                satuanPengeluaranEl.value = "pcs"; // Default unit
                hargaSatuanPengeluaranEl.value = '';
            }
        });

        function renderTable() {
            tabelTransaksi.innerHTML = '';
            // Create a copy for sorting without modifying the original 'transactions' array order
            const displayTransactions = transactions.slice(0); 
            // Sort by date descending for display
            displayTransactions.sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal)); 

            if (displayTransactions.length === 0) {
                tabelTransaksi.innerHTML = `<tr><td colspan="9" class="px-4 py-10 text-sm text-center" style="color: var(--neumorph-text-light);">Belum ada transaksi. Silakan tambahkan data baru.</td></tr>`;
            } else {
                displayTransactions.forEach((trx) => { 
                    // Find original index from the unsorted 'transactions' array for deletion
                    const originalIndex = transactions.findIndex(t => t.id === trx.id); 
                    const row = tabelTransaksi.insertRow();
                    row.className = 'hover:bg-gray-50 transition-colors duration-150'; // Keep Tailwind class or make custom
                    row.insertCell().textContent = trx.tanggal;
                    row.insertCell().innerHTML = `<span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${trx.jenis === 'Pemasukan' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${trx.jenis}</span>`;
                    row.insertCell().textContent = trx.deskripsi;
                    row.insertCell().textContent = trx.kuantitas !== undefined ? trx.kuantitas : '-';
                    row.insertCell().textContent = trx.satuan || '-';
                    row.insertCell().textContent = trx.hargaSatuan !== undefined ? formatRupiah(trx.hargaSatuan) : '-';
                    row.insertCell().textContent = trx.kategori || '-';
                    row.insertCell().innerHTML = `<span class="font-semibold ${trx.jenis === 'Pemasukan' ? 'text-green-700' : 'text-red-700'}">${formatRupiah(trx.total)}</span>`;
                    
                    const aksiCell = row.insertCell();
                    aksiCell.className = 'text-center';
                    const deleteButton = document.createElement('button');
                    deleteButton.innerHTML = `<i class="fas fa-trash-alt"></i>`;
                    deleteButton.title = "Hapus Transaksi";
                    // Apply neumorph style to delete button or keep it simple
                    deleteButton.className = 'p-2 rounded-md text-red-500 hover:text-red-700 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-400 transition-all';
                    if (originalIndex !== -1) {
                         deleteButton.onclick = () => deleteTransaction(originalIndex); 
                    } else {
                        // This case should ideally not happen if IDs are unique and managed correctly
                        console.warn("Transaksi tidak ditemukan di array asli untuk penghapusan:", trx);
                        deleteButton.disabled = true;
                    }
                    aksiCell.appendChild(deleteButton);
                });
            }
            updateSummary();
            saveTransactionsToLocalStorage(); // Save after any modification
            renderCharts(); // Update charts with new data
        }
        
        function showModal(title, message, type = 'info', deleteIndex = -1) {
            modalTitleEl.textContent = title;
            modalMessageText.innerHTML = message; // Allow HTML for messages like line breaks
            modalActionsEl.innerHTML = ''; // Clear previous actions

            let iconClass = 'fas fa-info-circle text-blue-500'; // Default icon
            if (type === 'success') iconClass = 'fas fa-check-circle text-green-500';
            else if (type === 'error') iconClass = 'fas fa-times-circle text-red-500';
            else if (type === 'confirm-delete' || type === 'warning') iconClass = 'fas fa-exclamation-triangle text-yellow-500';
            else if (type === 'pending') iconClass = 'fas fa-spinner fa-spin text-blue-500'; // For loading/pending states
            
            // Set icon in title
            modalTitleEl.innerHTML = `<i class="${iconClass} mr-2"></i> ${title}`;

            if (type === 'confirm-delete' && deleteIndex !== -1 && deleteIndex < transactions.length) { 
                const confirmButton = document.createElement('button');
                confirmButton.innerHTML = '<i class="fas fa-trash-alt mr-1"></i> Ya, Hapus'; 
                confirmButton.className = 'neumorph-button btn-red text-sm'; // Neumorph styled
                confirmButton.onclick = () => {
                    transactions.splice(deleteIndex, 1); renderTable();
                    messageModal.style.display = "none";
                    showModal("Berhasil", `Transaksi berhasil dihapus dari daftar lokal.`, 'success');
                };
                const cancelButton = document.createElement('button');
                cancelButton.innerHTML = '<i class="fas fa-ban mr-1"></i> Batal';
                cancelButton.className = 'neumorph-button text-sm'; // Neumorph styled
                cancelButton.style.color = 'var(--neumorph-text-light)';
                cancelButton.onclick = () => { messageModal.style.display = "none"; };
                modalActionsEl.appendChild(cancelButton); // Cancel first for common UX
                modalActionsEl.appendChild(confirmButton);
            } else {
                const closeButtonModal = document.createElement('button');
                closeButtonModal.innerHTML = '<i class="fas fa-times mr-1"></i> Tutup';
                closeButtonModal.className = 'neumorph-button text-sm'; // Neumorph styled
                closeButtonModal.style.color = 'var(--neumorph-text-color)';
                closeButtonModal.onclick = () => { messageModal.style.display = "none"; };
                modalActionsEl.appendChild(closeButtonModal);

                // Auto-hide for success/info modals after a delay
                if ((type === 'success' || type === 'info') && type !== 'error' && type !== 'pending') { 
                    setTimeout(() => { 
                        // Check if this specific modal is still open before closing
                        if (messageModal.style.display === "block" && modalTitleEl.textContent === title) { 
                           messageModal.style.display = "none";
                        }
                    }, 3000); 
                }
            }
            messageModal.style.display = "block";
        }

        function deleteTransaction(index) {
            if (index >= 0 && index < transactions.length) {
                 const trxDeskripsi = transactions[index].deskripsi;
                 showModal("Konfirmasi Hapus", `Apakah Anda yakin ingin menghapus transaksi "${trxDeskripsi}"? Tindakan ini hanya menghapus data dari tampilan lokal dan tidak dapat diurungkan.`, 'confirm-delete', index);
            } else {
                console.error("Indeks hapus tidak valid:", index);
                showModal("Error", "Gagal menghapus transaksi: Indeks tidak valid.", "error");
            }
        }

        function updateSummary() {
            const totalPemasukan = transactions.filter(t => t.jenis === 'Pemasukan').reduce((sum, t) => sum + t.total, 0);
            const totalPengeluaran = transactions.filter(t => t.jenis === 'Pengeluaran').reduce((sum, t) => sum + t.total, 0);
            const saldoAkhir = totalPemasukan - totalPengeluaran;

            totalPemasukanEl.textContent = formatRupiah(totalPemasukan);
            totalPengeluaranEl.textContent = formatRupiah(totalPengeluaran);
            saldoAkhirEl.textContent = formatRupiah(saldoAkhir);

            let persentaseText = 'N/A';
            if (totalPemasukan === 0 && totalPengeluaran === 0 && saldoAkhir === 0) {
                 persentaseText = '0.00%';
            } else if (totalPemasukan > 0) {
                const persentase = (saldoAkhir / totalPemasukan) * 100;
                persentaseText = persentase.toFixed(2) + '%';
            }
            persentaseKeuntunganValueEl.textContent = persentaseText;
        }

        function renderCharts() {
            renderLineChart();
            renderPieChart('Bahan Baku', 'bahanBakuPieChart', 'bahanBakuChartMessage', bahanBakuPieChartInstance, (instance) => bahanBakuPieChartInstance = instance);
            renderPieChart('Bahan Habis Pakai', 'bahanHabisPakaiPieChart', 'bahanHabisPakaiChartMessage', bahanHabisPakaiPieChartInstance, (instance) => bahanHabisPakaiPieChartInstance = instance);
        }
        
        function renderLineChart() {
            const canvasEl = document.getElementById('transactionLineChart');
            const messageEl = lineChartMessageEl; // Already defined
            if (!canvasEl) {
                console.error("Canvas 'transactionLineChart' tidak ditemukan.");
                if(messageEl) { messageEl.textContent = "Canvas untuk grafik garis tidak ditemukan."; messageEl.classList.remove('hidden');}
                return;
            }
            const ctx = canvasEl.getContext('2d');
            if (transactionLineChartInstance) { transactionLineChartInstance.destroy(); }
            
            // Check if there's enough data for a line chart (e.g., at least 2 points for a line)
            if (transactions.length < 2) { 
                if(messageEl) { messageEl.textContent = transactions.length === 0 ? "Belum ada data transaksi untuk ditampilkan." : "Data transaksi belum cukup untuk membuat grafik garis."; messageEl.classList.remove('hidden'); }
                canvasEl.classList.add('hidden'); // Hide canvas if no data
                transactionLineChartInstance = null;
                return;
            } else {
                if(messageEl) messageEl.classList.add('hidden');
                canvasEl.classList.remove('hidden');
            }

            const sortedTransactions = [...transactions].sort((a, b) => new Date(a.tanggal) - new Date(b.tanggal));
            let cumulativeBalance = 0;
            const chartLabels = [], incomeDataPoints = [], expenseDataPoints = [], balanceDataPoints = [];
            // Aggregate data by day
            const dailyAggregates = new Map(), endOfDayBalances = new Map(); 

            sortedTransactions.forEach(trx => {
                const date = trx.tanggal;
                if (!dailyAggregates.has(date)) { dailyAggregates.set(date, { income: 0, expense: 0 }); }
                if (trx.jenis === 'Pemasukan') { dailyAggregates.get(date).income += trx.total; cumulativeBalance += trx.total; } 
                else if (trx.jenis === 'Pengeluaran') { dailyAggregates.get(date).expense += trx.total; cumulativeBalance -= trx.total; }
                endOfDayBalances.set(date, cumulativeBalance); // Store balance at the end of each transaction for that day
            });
            // Use unique sorted dates for labels
            const uniqueSortedDates = Array.from(new Set(sortedTransactions.map(t => t.tanggal))).sort((a,b) => new Date(a) - new Date(b));
            uniqueSortedDates.forEach(date => {
                // Format date for display (e.g., "DD MMM")
                chartLabels.push(new Date(date).toLocaleDateString('id-ID', { day: 'numeric', month: 'short' })); 
                incomeDataPoints.push(dailyAggregates.get(date)?.income || 0);
                expenseDataPoints.push(dailyAggregates.get(date)?.expense || 0);
                balanceDataPoints.push(endOfDayBalances.get(date) || 0); // Use the last balance recorded for this day
            });

            transactionLineChartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels: chartLabels,
                    datasets: [
                        { label: 'Pemasukan', data: incomeDataPoints, borderColor: 'rgba(22, 163, 74, 1)', backgroundColor: 'rgba(22, 163, 74, 0.1)', fill: true, tension: 0.3, pointBackgroundColor: 'rgba(22, 163, 74, 1)', pointBorderColor: '#fff', pointHoverRadius: 7, pointHoverBackgroundColor: 'rgba(22, 163, 74, 1)', yAxisID: 'y' },
                        { label: 'Pengeluaran', data: expenseDataPoints, borderColor: 'rgba(220, 38, 38, 1)', backgroundColor: 'rgba(220, 38, 38, 0.1)', fill: true, tension: 0.3, pointBackgroundColor: 'rgba(220, 38, 38, 1)', pointBorderColor: '#fff', pointHoverRadius: 7, pointHoverBackgroundColor: 'rgba(220, 38, 38, 1)', yAxisID: 'y' },
                        { label: 'Saldo', data: balanceDataPoints, borderColor: 'rgba(37, 99, 235, 1)', backgroundColor: 'rgba(37, 99, 235, 0.05)', fill: 'origin', tension: 0.3, pointBackgroundColor: 'rgba(37, 99, 235, 1)', pointBorderColor: '#fff', pointHoverRadius: 7, pointHoverBackgroundColor: 'rgba(37, 99, 235, 1)', yAxisID: 'y' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, 
                    animation: false, // Disable animation for consistency, can be enabled
                    scales: { y: { beginAtZero: false, position: 'left', grid: { color: '#e5e7eb' }, ticks: { callback: function(value) { return formatRupiah(value); }, color: 'var(--neumorph-text-light)'}}, x: { grid: { display: false }, ticks: { color: 'var(--neumorph-text-light)' }}},
                    plugins: { legend: { display: true, position: 'bottom', labels: { color: 'var(--neumorph-text-color)', font: { size: 13 }}},
                        tooltip: { mode: 'index', intersect: false, backgroundColor: 'rgba(0,0,0,0.8)', titleFont: { size: 14, weight: 'bold' }, bodyFont: { size: 12 }, padding: 10, cornerRadius: 6, callbacks: { label: function(context) { let label = context.dataset.label || ''; if (label) { label += ': '; } if (context.parsed.y !== null) { label += formatRupiah(context.parsed.y); } return label; }}}
                    },
                    interaction: { mode: 'nearest', axis: 'x', intersect: false }
                }
            });
        }

        function renderPieChart(categoryName, canvasId, messageElId, chartInstance, setChartInstanceCallback) {
            const canvasEl = document.getElementById(canvasId);
            const messageEl = document.getElementById(messageElId); // Get the message element
            if (!canvasEl) {
                console.error(`Canvas element tidak ditemukan: ${canvasId}`);
                if (messageEl) { messageEl.textContent = `Canvas untuk ${categoryName} tidak ditemukan.`; messageEl.classList.remove('hidden');}
                return;
            }
            const ctx = canvasEl.getContext('2d');
            if (chartInstance) { chartInstance.destroy(); }

            const categoryExpenses = transactions.filter( trx => trx.jenis === 'Pengeluaran' && trx.kategori === categoryName && trx.kuantitas !== undefined && trx.satuan !== undefined );
            if (categoryExpenses.length === 0) {
                // Display message if no data
                if (messageEl) { messageEl.textContent = `Tidak ada data pengeluaran untuk ${categoryName}.`; messageEl.classList.remove('hidden');}
                canvasEl.classList.add('hidden'); // Hide canvas
                setChartInstanceCallback(null);
                return;
            }
            // Hide message and show canvas if data exists
            if (messageEl) { messageEl.classList.add('hidden'); }
            canvasEl.classList.remove('hidden');

            const expenseByItem = categoryExpenses.reduce((acc, trx) => {
                if (!acc[trx.deskripsi]) { acc[trx.deskripsi] = { total: 0, quantities: {} }; }
                acc[trx.deskripsi].total += trx.total;
                // Sum quantities by unit
                acc[trx.deskripsi].quantities[trx.satuan] = (acc[trx.deskripsi].quantities[trx.satuan] || 0) + parseFloat(trx.kuantitas);
                return acc;
            }, {});

            const labels = Object.keys(expenseByItem);
            const data = labels.map(label => expenseByItem[label].total);
            // Store metadata (like quantities) for tooltips/datalabels
            const metaDataForChart = labels.map(label => ({ quantities: expenseByItem[label].quantities }));
            // Define colors for pie chart slices
            const pieColors = [ '#3b82f6', '#ef4444', '#f59e0b', '#10b981', '#8b5cf6', '#ec4899', '#6366f1', '#d946ef', '#06b6d4', '#f43f5e' ]; // Example colors

            const newInstance = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: labels,
                    datasets: [{ label: `Pengeluaran ${categoryName}`, data: data, backgroundColor: pieColors.slice(0, labels.length).map(color => `${color}CC`), borderColor: pieColors.slice(0, labels.length), borderWidth: 1.5, hoverOffset: 10, hoverBorderWidth: 2 }],
                    metaData: metaDataForChart // Pass metadata here
                },
                options: { responsive: true, maintainAspectRatio: false, cutout: '60%',
                    animation: false, // Disable animation for consistency
                    plugins: {
                        legend: { 
                            display: false // Usually better to hide legend if using datalabels effectively
                        },
                        tooltip: { backgroundColor: 'rgba(0,0,0,0.85)', titleFont: { size: 13, weight: 'bold' }, bodyFont: { size: 12 }, padding: 12, cornerRadius: 6,
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    const value = context.raw;
                                    const sum = context.chart.getDatasetMeta(0).total || data.reduce((a, b) => a + b, 0); // Calculate sum if not available in meta
                                    const percentage = sum > 0 ? ((value / sum) * 100).toFixed(1) + '%' : '0.0%';
                                    let tooltipText = `${label}: ${formatRupiah(value)} (${percentage})`;
                                    // Add quantity info from metadata
                                    const itemMetaData = context.chart.data.metaData[context.dataIndex];
                                    if (itemMetaData && itemMetaData.quantities) {
                                        const quantityParts = [];
                                        for (const unit in itemMetaData.quantities) {
                                            const quantityValue = parseFloat(itemMetaData.quantities[unit]);
                                            if (!isNaN(quantityValue)) {
                                                // Format quantity (e.g., 2.50 to 2.5, 2.00 to 2)
                                                const formattedQuantity = Number.isInteger(quantityValue) ? quantityValue : quantityValue.toFixed(2);
                                                quantityParts.push(`${formattedQuantity} ${unit}`);
                                            }
                                        }
                                        if (quantityParts.length > 0) { tooltipText += `\nKuantitas: ${quantityParts.join(', ')}`; }
                                    }
                                    return tooltipText.split('\n'); // Return as array for multi-line tooltips
                                }
                            }
                        },
                        datalabels: {
                            formatter: (value, context) => {
                                const label = context.chart.data.labels[context.dataIndex];
                                const percentageNum = (value / context.chart.getDatasetMeta(0).total) * 100;
                                
                                // Hide label if percentage is too small (e.g., less than 4%) to avoid clutter
                                if (percentageNum < 4) { 
                                    return null;
                                }

                                // Retrieve quantity from metadata
                                const itemMetaData = context.chart.data.metaData[context.dataIndex];
                                let quantityText = "";
                                if (itemMetaData && itemMetaData.quantities) {
                                    const quantityParts = [];
                                    for (const unit in itemMetaData.quantities) {
                                        const quantityValue = parseFloat(itemMetaData.quantities[unit]);
                                        if (!isNaN(quantityValue)) {
                                            const formattedQuantity = Number.isInteger(quantityValue) ? quantityValue : quantityValue.toFixed(1); // Shorter for display
                                            quantityParts.push(`${formattedQuantity}${unit}`); // e.g., 2.5kg
                                        }
                                    }
                                    if (quantityParts.length > 0) { 
                                        quantityText = quantityParts.join(', ');
                                        if (quantityText.length > 10) quantityText = quantityText.substring(0,8) + ".."; // Truncate if too long
                                    }
                                }
                                
                                // Shorten label if too long
                                const shortLabel = label.length > 12 ? label.substring(0, 10) + '...' : label; 
                                let output = shortLabel + '\n' + formatRupiah(value);
                                if (quantityText) {
                                    output += '\n(' + quantityText + ')';
                                }
                                return output;
                            },
                            color: (context) => { // Choose text color based on background for better contrast
                                const bgColor = context.dataset.backgroundColor[context.dataIndex] || '#000000';
                                // Simple brightness check (more sophisticated methods exist)
                                const color = bgColor.length > 7 ? bgColor.substring(1,7) : bgColor.substring(1); // Handle 'RRGGBBAA' or 'RRGGBB'
                                const r = parseInt(color.substring(0,2), 16);
                                const g = parseInt(color.substring(2,4), 16);
                                const b = parseInt(color.substring(4,6), 16);
                                return (r * 0.299 + g * 0.587 + b * 0.114) > 186 ? '#1f2937' : '#f9fafb'; // Dark text on light bg, Light text on dark bg
                            },
                            font: { weight: '600', size: 10 }, 
                            textAlign: 'center',
                            anchor: 'center', // Position label in the center of the arc
                            align: 'center',  // Align text within its box
                            offset: 0, // No offset from center
                            clamp: true, // Prevent labels from going outside chart area
                            display: 'auto', // Automatically hide labels if they overlap too much
                            borderRadius: 4,
                            backgroundColor: (context) => { // Semi-transparent background for datalabel
                                const sliceColor = context.dataset.backgroundColor[context.dataIndex] || '#808080';
                                const baseColor = sliceColor.length > 7 ? sliceColor.substring(0, 7) : sliceColor; // Get RGB part
                                return baseColor.length === 7 ? baseColor + 'E6' : '#4B5563E6'; // Add alpha (E6 ~ 90%)
                            },
                            padding: { top: 3, bottom: 3, left: 5, right: 5 }, // Padding inside datalabel box
                            textStrokeColor: (context) => { // Subtle stroke for readability on complex backgrounds
                                const bgColor = context.dataset.backgroundColor[context.dataIndex] || '#000000';
                                const color = bgColor.length > 7 ? bgColor.substring(1,7) : bgColor.substring(1);
                                const r = parseInt(color.substring(0,2), 16);
                                const g = parseInt(color.substring(2,4), 16);
                                const b = parseInt(color.substring(4,6), 16);
                                return (r * 0.299 + g * 0.587 + b * 0.114) > 186 ? 'rgba(255,255,255,0.6)' : 'rgba(0,0,0,0.6)';
                            },
                            textStrokeWidth: 1
                        }
                    }
                }
            });
            setChartInstanceCallback(newInstance);
        }

        function showSheetSendStatus(message, type = 'info') {
            sheetSendStatusEl.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-times-circle' : type === 'pending' ? 'fa-spinner fa-spin' : 'fa-info-circle'} mr-2"></i> ${message}`; 
            // Clear existing type classes before adding new one
            sheetSendStatusEl.className = 'status-message-neumorph my-6'; // Base class
            if (type === 'success') sheetSendStatusEl.classList.add('success');
            else if (type === 'error') sheetSendStatusEl.classList.add('error');
            else if (type === 'pending') sheetSendStatusEl.classList.add('pending');
            else sheetSendStatusEl.classList.add('info'); // Default to 'info'
            
            sheetSendStatusEl.classList.remove('hidden');
            // Auto-hide if not a pending message
            if (type !== 'pending') { setTimeout(() => { sheetSendStatusEl.classList.add('hidden'); }, 5000); }
        }

        async function sendTransactionToSheet(transactionData, loaderElement, submitButtonElement) {
            let SCRIPT_URL = localStorage.getItem(appsScriptUrlKey) || DEFAULT_APPS_SCRIPT_URL;
            if (!SCRIPT_URL) {
                showSheetSendStatus("URL Google Apps Script belum dikonfigurasi.", "error");
                if (loaderElement) loaderElement.classList.add('hidden');
                if (submitButtonElement) submitButtonElement.disabled = false;
                return;
            }
            // Show loader and disable button
            if (loaderElement) loaderElement.classList.remove('hidden');
            if (submitButtonElement) submitButtonElement.disabled = true;
            showSheetSendStatus(`Mengirim data "${transactionData.deskripsi}" ke Google Sheet...`, "pending");

            // Prepare payload exactly as Apps Script expects
            const payload = {
                tanggal: transactionData.tanggal, jenis: transactionData.jenis, deskripsi: transactionData.deskripsi,
                kuantitas: transactionData.kuantitas !== undefined ? transactionData.kuantitas : '', // Handle undefined
                satuan: transactionData.satuan || '', // Handle undefined or empty
                hargaSatuan: transactionData.hargaSatuan !== undefined ? transactionData.hargaSatuan : '', // Handle undefined
                kategori: transactionData.kategori || '', // Handle undefined or empty
                total: transactionData.total
            };

            try {
                // Apps Script Web App often expects a stringified payload when Content-Type is 'text/plain'
                // For 'application/json', it would be `JSON.stringify({ action: 'create', data: payload })` if script handles it
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST', mode: 'cors', cache: 'no-cache', // CORS is important
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // Common for simple Apps Script POST
                    body: JSON.stringify(payload), // Send the transaction data as a JSON string
                    redirect: 'follow' // Important for Apps Script redirects
                });
                if (!response.ok) {
                    // Try to get more detailed error from response body if available
                    const errorText = await response.text(); 
                    throw new Error(`Network response not ok: ${response.status} ${response.statusText}. Detail: ${errorText}`);
                }
                const resultText = await response.text(); // Apps Script often returns text/JSON
                let result;
                try { result = JSON.parse(resultText); } 
                catch (e) { throw new Error(`Respons Apps Script tidak valid: ${resultText.substring(0,100)}...`); } // Show part of response if not JSON

                if (result.status === "success") {
                    showSheetSendStatus(`Data "${transactionData.deskripsi}" berhasil dikirim ke Google Sheet!`, 'success');
                } else {
                    // Log detailed error from Apps Script if available
                    console.error("Gagal kirim ke Sheet (Apps Script):", result.message, result.dataReceived, result.requestContent);
                    showSheetSendStatus(`Gagal kirim ke Sheet: ${result.message}. Cek konsol.`, 'error');
                }
            } catch (error) {
                console.error("Error kirim ke Sheet (fetch):", error);
                showSheetSendStatus(`Error koneksi ke Sheet: ${error.message}. Cek konsol & URL.`, 'error');
            } finally {
                // Hide loader and re-enable button
                if (loaderElement) loaderElement.classList.add('hidden');
                if (submitButtonElement) submitButtonElement.disabled = false;
            }
        }

        async function loadTransactionsFromSheet() {
            let SCRIPT_URL = localStorage.getItem(appsScriptUrlKey) || DEFAULT_APPS_SCRIPT_URL;
            if (!SCRIPT_URL) {
                let errorMsg = "URL Google Apps Script belum dikonfigurasi. Tidak dapat memuat data dari sheet.<br>Silakan masukkan URL di Pengaturan.";
                showModal("Konfigurasi Diperlukan", errorMsg, "warning");
                loadTransactionsFromLocalStorage(); // Fallback to local storage
                if (loadingOverlay) loadingOverlay.classList.add('hidden');
                renderTable(); // Render whatever is loaded (local or empty)
                return; // Stop further execution
            }

            if (loadingOverlay) loadingOverlay.classList.remove('hidden'); // Show loading overlay

            try {
                // Append ?action=read or similar to tell Apps Script what to do
                const response = await fetch(SCRIPT_URL + '?action=read', { method: 'GET', mode: 'cors', redirect: 'follow' }); 
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Gagal memuat data dari sheet: ${response.status} ${response.statusText}. Detail: ${errorText}`);
                }
                const resultText = await response.text();
                let result;
                try { result = JSON.parse(resultText); } 
                catch (e) { throw new Error(`Respons data dari Apps Script tidak valid: ${resultText.substring(0,200)}...`); }

                if (result.status === "success" && Array.isArray(result.data)) {
                    // Process and map data, ensure all necessary fields are present, generate local IDs
                    transactions = result.data.filter(trx => trx.tanggal && trx.deskripsi && trx.jenis).map((trx, index) => ({
                        ...trx,
                        // Ensure numeric types for calculations
                        kuantitas: trx.kuantitas !== undefined && trx.kuantitas !== '' ? parseFloat(trx.kuantitas) : undefined,
                        hargaSatuan: trx.hargaSatuan !== undefined && trx.hargaSatuan !== '' ? parseFloat(trx.hargaSatuan) : undefined,
                        total: trx.total !== undefined && trx.total !== '' ? parseFloat(trx.total) : 0,
                        id: `sheet_${Date.now()}_${index}` // Unique ID for local handling
                    })); 
                    showModal("Sinkronisasi Berhasil", "Data berhasil dimuat dan disinkronkan dari Google Spreadsheet.", "success");
                } else if (result.status === "error") {
                    let detailedErrorMessage = `Error dari Apps Script: ${result.message}`;
                    // Check for specific common errors, like sheet not found
                    if (result.message && result.message.toLowerCase().includes("sheet") && result.message.toLowerCase().includes("tidak ditemukan")) {
                         detailedErrorMessage += "<br><br><b>Tips:</b> Pastikan nama sheet di Google Spreadsheet Anda adalah '<b>Transaksi</b>' (sesuai pengaturan di Apps Script Anda). Jika Anda baru mengubah nama sheet atau membuat sheet baru, deploy ulang Apps Script Anda.";
                    }
                    throw new Error(detailedErrorMessage);
                } else {
                    throw new Error("Format data dari Apps Script tidak dikenali.");
                }
            } catch (error) {
                console.error("Error memuat data dari Sheet:", error);
                let userErrorMessage = `Gagal memuat data dari Google Sheet: ${error.message}.`;
                // Specific guidance for "Sheet 'Transaksi' not found"
                if (error.message && error.message.includes("Sheet 'Transaksi' tidak ditemukan")) { // Example check
                    userErrorMessage = `Gagal memuat data dari Google Sheet: ${error.message}.<br><br><b>Tips Penting:</b><br>1. Pastikan nama sheet di Google Spreadsheet Anda adalah persis '<b>Transaksi</b>' (perhatikan huruf besar/kecil).<br>2. Jika Anda baru membuat atau mengganti nama sheet, Anda harus <b>Deploy Ulang Web App</b> di Google Apps Script (Deploy > Manage deployments > Edit (ikon pensil) > New version > Deploy).<br><br>Memuat data lokal jika ada.`;
                } else {
                     userErrorMessage += " Memuat data lokal jika ada.";
                }
                showModal("Error Sinkronisasi", userErrorMessage, "error"); 
                loadTransactionsFromLocalStorage(); // Fallback to local
            } finally {
                if (loadingOverlay) { loadingOverlay.classList.add('hidden'); }
                // Use requestAnimationFrame for smoother UI update after data load
                requestAnimationFrame(() => { 
                    setTimeout(() => { // Additional timeout can sometimes help ensure DOM is ready
                        try { renderTable(); } 
                        catch (renderError) { console.error("Error saat renderTable setelah loadTransactionsFromSheet (via rAF):", renderError); showModal("Error Tampilan", "Terjadi kesalahan saat menampilkan data.", "error");}
                    }, 0);
                });
            }
        }

        formPengeluaran.addEventListener('submit', function(event) {
            event.preventDefault();
            const newTransaction = {
                id: `local_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`, // Unique local ID
                jenis: 'Pengeluaran', tanggal: tanggalPengeluaranEl.value, deskripsi: deskripsiPengeluaranEl.value,
                kuantitas: parseFloat(kuantitasPengeluaranEl.value), satuan: satuanPengeluaranEl.value,
                hargaSatuan: parseFloat(hargaSatuanPengeluaranEl.value), kategori: kategoriPengeluaranEl.value,
                total: parseFloat(kuantitasPengeluaranEl.value) * parseFloat(hargaSatuanPengeluaranEl.value)
            };
            // Basic validation
            if (!newTransaction.tanggal || newTransaction.deskripsi === "" || isNaN(newTransaction.kuantitas) || !newTransaction.satuan || isNaN(newTransaction.hargaSatuan) || !newTransaction.kategori) {
                showModal("Input Tidak Lengkap", "Mohon lengkapi semua field pengeluaran dengan benar.", "warning"); return;
            }
            if (newTransaction.kuantitas <= 0 || newTransaction.hargaSatuan < 0) { // Harga satuan bisa 0 (gratis) tapi tidak negatif
                showModal("Input Tidak Valid", "Kuantitas harus lebih dari 0 dan harga satuan tidak boleh negatif.", "warning"); return;
            }

            transactions.push(newTransaction);
            renderTable(); // Update UI
            sendTransactionToSheet(newTransaction, loaderPengeluaran, submitPengeluaranBtn); // Send to sheet
            formPengeluaran.reset(); // Clear form
            tanggalPengeluaranEl.value = today; // Reset date to today
            populateDeskripsiPengeluaran(); // Repopulate if needed, or just reset
            deskripsiPengeluaranEl.value = ""; // Clear deskripsi
            kategoriPengeluaranEl.value = "Bahan Baku"; // Reset kategori
            satuanPengeluaranEl.value = "pcs"; // Reset satuan
            hargaSatuanPengeluaranEl.value = ''; // Clear harga
            showModal("Berhasil", "Data pengeluaran berhasil ditambahkan.", "success");
        });

        formPemasukan.addEventListener('submit', function(event) {
            event.preventDefault();
            const newTransaction = {
                id: `local_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`, // Unique local ID
                jenis: 'Pemasukan', tanggal: tanggalPemasukanEl.value,
                deskripsi: deskripsiPemasukanEl.value, total: parseFloat(jumlahPemasukanEl.value)
                // Pemasukan typically doesn't have kuantitas, satuan, kategori in this simple model
            };
             // Basic validation
            if (!newTransaction.tanggal || !newTransaction.deskripsi || isNaN(newTransaction.total)) {
                showModal("Input Tidak Lengkap", "Mohon lengkapi semua field pemasukan dengan benar.", "warning"); return;
            }
            if (newTransaction.total <= 0) {
                showModal("Input Tidak Valid", "Jumlah pemasukan harus lebih besar dari 0.", "warning"); return;
            }

            transactions.push(newTransaction);
            renderTable(); // Update UI
            sendTransactionToSheet(newTransaction, loaderPemasukan, submitPemasukanBtn); // Send to sheet
            formPemasukan.reset(); // Clear form
            tanggalPemasukanEl.value = today; // Reset date to today
            deskripsiPemasukanEl.value = "Setoran"; // Reset deskripsi to default
            showModal("Berhasil", "Data pemasukan berhasil ditambahkan.", "success");
        });
        
        function convertToCSV(data) {
            // Define headers based on the fields you want in CSV
            const headers = "Tanggal,Jenis Transaksi,Deskripsi,Kuantitas,Satuan,Harga Satuan (Rp),Kategori Pengeluaran,Total (Rp)";
            const rows = data.map(trx => [
                trx.tanggal, trx.jenis, `"${(trx.deskripsi || '').replace(/"/g, '""')}"`, // Handle commas/quotes in description
                trx.kuantitas !== undefined ? trx.kuantitas : '', // Handle potential undefined
                trx.satuan || '', trx.hargaSatuan !== undefined ? trx.hargaSatuan : '',
                trx.kategori || '', trx.total
            ].join(','));
            return [headers, ...rows].join('\n');
        }

        tombolEkspor.addEventListener('click', function() {
            if (transactions.length === 0) {
                showModal("Tidak Ada Data", "Tidak ada data transaksi untuk diekspor.", "info"); return;
            }
            const csvData = convertToCSV(transactions);
            const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) { // Check for browser support
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                // Generate a filename with current date
                link.setAttribute('download', `LaporanKeuanganBatagor_${new Date().toISOString().slice(0,10).replace(/-/g,"")}.txt`);
                link.style.visibility = 'hidden'; document.body.appendChild(link);
                link.click(); document.body.removeChild(link);
                URL.revokeObjectURL(url); // Clean up
                showModal("Ekspor Berhasil", "Data transaksi berhasil diekspor sebagai file teks (CSV format).", "success");
            } else {
                showModal("Ekspor Gagal", "Browser Anda tidak mendukung fitur unduh otomatis. Silakan coba browser lain.", "error");
            }
        });

        // Tab switching logic
        const tabLinks = document.querySelectorAll('.tab-link');
        const tabContents = document.querySelectorAll('.tab-content');
        tabLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                // Deactivate all tabs
                tabLinks.forEach(l => { l.classList.remove('active-tab'); l.classList.remove('active'); /* Neumorph active state */ });
                tabContents.forEach(c => c.classList.remove('active'));
                // Activate clicked tab
                link.classList.add('active-tab');
                link.classList.add('active'); // For neumorph .active style on button

                const targetTabId = link.getAttribute('data-tab');
                const targetContent = document.getElementById(targetTabId);
                if (targetContent) {
                    targetContent.classList.add('active');
                    // If switching to a tab with charts, re-render them to ensure they are displayed correctly
                    // Especially if they were hidden and their dimensions might not have been calculated properly.
                    if (targetTabId === 'grafikContainerTab') { 
                        // Small delay to ensure tab is visible before rendering charts
                        setTimeout(() => renderCharts(), 700); // Increased delay for safety
                    }
                } else {
                    console.error("Target tab content not found:", targetTabId);
                }
            });
        });
        
        function saveSettings() {
            const url = appsScriptUrlInput.value.trim();
            const viewUrl = googleSheetViewUrlInput.value.trim();
            let statusMsg = ""; let statusType = "info"; // Default status

            if (url) {
                try { new URL(url); localStorage.setItem(appsScriptUrlKey, url); statusMsg = "URL Web App disimpan. "; statusType = 'success';} 
                catch (_) { statusMsg = "Format URL Web App tidak valid. "; statusType = 'error';}
            } else { localStorage.removeItem(appsScriptUrlKey); statusMsg = "URL Web App dihapus (akan menggunakan default jika ada). "; }
            
            if (viewUrl) {
                try { new URL(viewUrl); localStorage.setItem(googleSheetViewUrlKey, viewUrl); viewSheetLinkButton.href = viewUrl; viewSheetLinkButton.classList.remove('hidden'); statusMsg += "Link Lihat Sheet disimpan."; statusType = statusType === 'error' ? 'error' : 'success';} // Preserve error if URL was bad
                catch (_) { statusMsg += "Format URL Lihat Sheet tidak valid."; statusType = 'error'; viewSheetLinkButton.classList.add('hidden');}
            } else { localStorage.removeItem(googleSheetViewUrlKey); viewSheetLinkButton.href = "#"; viewSheetLinkButton.classList.add('hidden'); statusMsg += "Link Lihat Sheet dihapus.";}
            
            // Display status message
            settingsStatusEl.innerHTML = `<i class="fas ${statusType === 'success' ? 'fa-check-circle text-green-600' : statusType === 'error' ? 'fa-times-circle text-red-600' : 'fa-info-circle text-yellow-600'} mr-1"></i> ${statusMsg}`;
            settingsStatusEl.className = `mt-4 text-sm text-center`; // Reset class
            
            // Auto-hide status and modal on success
            setTimeout(() => { 
                if (statusType === 'success') settingsModal.style.display = 'none'; 
                settingsStatusEl.textContent = ''; // Clear status message
                settingsStatusEl.className = 'mt-4 text-sm text-center'; // Reset class
            }, statusType === 'success' ? 2500 : 4000); // Longer for errors

            // If settings changed successfully, reload data from sheet
            if (statusType === 'success' && url) {
                showModal("Sinkronisasi Ulang", "Pengaturan disimpan. Memuat ulang data dari Google Sheet...", "info");
                loadTransactionsFromSheet(); // This will use the new URL
            } else if (statusType === 'success' && !url) { // URL was removed
                showModal("Pengaturan Disimpan", "URL Web App dihapus. Aplikasi akan menggunakan URL default jika ada, atau hanya penyimpanan lokal.", "info");
                loadTransactionsFromLocalStorage(); // Load local as fallback
                renderTable();
            }
        }

        function loadSettings() {
            let savedUrl = localStorage.getItem(appsScriptUrlKey);
            const savedViewUrl = localStorage.getItem(googleSheetViewUrlKey);

            appsScriptUrlInput.value = savedUrl || DEFAULT_APPS_SCRIPT_URL || ""; // Fallback to default or empty
            
            if (savedViewUrl) {
                googleSheetViewUrlInput.value = savedViewUrl;
                viewSheetLinkButton.href = savedViewUrl;
                viewSheetLinkButton.classList.remove('hidden');
            } else { 
                viewSheetLinkButton.href = "#"; // Default href if no URL
                viewSheetLinkButton.classList.add('hidden'); 
            }
        }

        // --- Fungsi Pembuatan PDF ---
        async function generateFinancialReportPDF() {
            showModal("Membuat PDF", "Sedang mempersiapkan laporan PDF... Mohon tunggu.", "pending");
            tombolUnduhPdf.disabled = true;
            const originalActiveTabId = document.querySelector('.tab-link.active-tab')?.getAttribute('data-tab');
            
            const { jsPDF } = window.jspdf;
            let pdf; 
            let firstPageCreated = false; 

            const includeSummary = includeSummaryPdfEl.checked;
            const includeLineChart = includeLineChartPdfEl.checked;
            const includePieBaku = includePieBakuPdfEl.checked;
            const includePieHabisPakai = includePieHabisPakaiPdfEl.checked;
            const includeTransactionTable = includeTransactionTablePdfEl.checked;

            if (!includeSummary && !includeLineChart && !includePieBaku && !includePieHabisPakai && !includeTransactionTable) {
                showModal("Tidak Ada Konten", "Pilih setidaknya satu bagian untuk disertakan dalam PDF.", "warning");
                tombolUnduhPdf.disabled = false;
                return;
            }
            
            try {
                const visualSectionsConfig = [];
                if (includeSummary) visualSectionsConfig.push({ title: 'Ringkasan Keuangan', type: 'cloneElement', elementId: 'ringkasanKeuanganContainer' });
                if (includeLineChart) visualSectionsConfig.push({ title: 'Grafik Transaksi Harian', type: 'chartImage', elementId: 'transactionLineChart', chartInstance: transactionLineChartInstance, messageElementId: 'lineChartMessage' });
                if (includePieBaku) visualSectionsConfig.push({ title: 'Rincian Pengeluaran Bahan Baku', type: 'chartImage', elementId: 'bahanBakuPieChart', chartInstance: bahanBakuPieChartInstance, messageElementId: 'bahanBakuChartMessage' });
                if (includePieHabisPakai) visualSectionsConfig.push({ title: 'Rincian Pengeluaran Bahan Habis Pakai', type: 'chartImage', elementId: 'bahanHabisPakaiPieChart', chartInstance: bahanHabisPakaiPieChartInstance, messageElementId: 'bahanHabisPakaiChartMessage' });

                for (const section of visualSectionsConfig) {
                    if (!firstPageCreated) {
                        pdf = new jsPDF('l', 'mm', 'a4'); 
                        firstPageCreated = true;
                    } else {
                        pdf.addPage('a4', 'l'); 
                    }

                    if (section.type === 'chartImage') {
                        const grafikTabLink = document.querySelector('.tab-link[data-tab="grafikContainerTab"]');
                        if (document.querySelector('.tab-link.active-tab')?.getAttribute('data-tab') !== 'grafikContainerTab' && grafikTabLink) {
                            grafikTabLink.click();
                            await new Promise(resolve => setTimeout(resolve, 1000)); 
                        } else if (document.querySelector('.tab-link.active-tab')?.getAttribute('data-tab') === 'grafikContainerTab') {
                            if (section.elementId === 'transactionLineChart' && transactionLineChartInstance) { renderLineChart(); }
                            else if (section.elementId === 'bahanBakuPieChart' && bahanBakuPieChartInstance) { renderPieChart('Bahan Baku', 'bahanBakuPieChart', 'bahanBakuChartMessage', bahanBakuPieChartInstance, (instance) => bahanBakuPieChartInstance = instance); }
                            else if (section.elementId === 'bahanHabisPakaiPieChart' && bahanHabisPakaiPieChartInstance) { renderPieChart('Bahan Habis Pakai', 'bahanHabisPakaiPieChart', 'bahanHabisPakaiChartMessage', bahanHabisPakaiPieChartInstance, (instance) => bahanHabisPakaiPieChartInstance = instance); }
                            await new Promise(resolve => setTimeout(resolve, 800)); 
                        }
                    }
                    
                    const pdfReportContainer = document.createElement('div');
                    pdfReportContainer.id = 'pdfReportTempContainer_' + section.elementId + Date.now(); 
                    pdfReportContainer.style.position = 'absolute';
                    pdfReportContainer.style.left = '-9999px'; 
                    pdfReportContainer.style.top = '-9999px';
                    pdfReportContainer.style.width = '1200px'; 
                    pdfReportContainer.style.padding = '15px'; 
                    pdfReportContainer.style.backgroundColor = 'white'; 
                    pdfReportContainer.style.boxSizing = 'border-box';
                    document.body.appendChild(pdfReportContainer);

                    // Membuat judul standar untuk PDF
                    const titleElForPdf = document.createElement('h2');
                    titleElForPdf.className = 'text-xl font-semibold text-gray-700 mb-2 text-center pt-1'; // pt-1 & mb-2
                    let iconClassForPdf = "fas fa-file-alt";
                    if (section.elementId === 'ringkasanKeuanganContainer') iconClassForPdf = "fas fa-wallet";
                    else if (section.elementId === 'transactionLineChart') iconClassForPdf = "fas fa-chart-line";
                    else if (section.elementId === 'bahanBakuPieChart' || section.elementId === 'bahanHabisPakaiPieChart') iconClassForPdf = "fas fa-chart-pie";
                    titleElForPdf.innerHTML = `<i class="${iconClassForPdf} mr-2"></i>${section.title}`;
                    titleElForPdf.style.color = 'var(--neumorph-text-color)'; // Pastikan warna abu-abu
                    pdfReportContainer.appendChild(titleElForPdf);


                    if (section.type === 'cloneElement' && section.elementId === 'ringkasanKeuanganContainer') {
                        const sourceElement = document.getElementById(section.elementId);
                        if (sourceElement) {
                            const clonedNode = sourceElement.cloneNode(true);
                            // Hapus judul H2 asli dari node yang dikloning karena kita sudah menambahkan titleElForPdf
                            const originalTitleInClone = clonedNode.querySelector('h2');
                            if (originalTitleInClone) {
                                originalTitleInClone.parentNode.removeChild(originalTitleInClone);
                            }
                            pdfReportContainer.appendChild(clonedNode);
                        } else {
                             pdfReportContainer.appendChild(document.createTextNode(`Error: Konten "${section.title}" tidak ditemukan.`));
                        }
                    } else if (section.type === 'chartImage') {
                        const chartCanvas = document.getElementById(section.elementId);
                        const messageElement = section.messageElementId ? document.getElementById(section.messageElementId) : null;
                        
                        let currentChartInstance = null;
                        if (section.elementId === 'transactionLineChart') currentChartInstance = transactionLineChartInstance;
                        else if (section.elementId === 'bahanBakuPieChart') currentChartInstance = bahanBakuPieChartInstance;
                        else if (section.elementId === 'bahanHabisPakaiPieChart') currentChartInstance = bahanHabisPakaiPieChartInstance;

                        let chartActuallyRendered = currentChartInstance && chartCanvas && !chartCanvas.classList.contains('hidden');

                        if (chartActuallyRendered) {
                            try {
                                const imgDataUrl = currentChartInstance.toBase64Image();
                                const img = document.createElement('img');
                                img.src = imgDataUrl;
                                img.style.width = '100%'; 
                                img.style.height = 'auto'; 
                                img.style.display = 'block';
                                img.style.margin = '5px auto'; 
                                await new Promise((resolve, reject) => {
                                    img.onload = resolve;
                                    img.onerror = () => reject(new Error(`Gagal memuat gambar chart: ${section.elementId}`));
                                    if (!imgDataUrl || imgDataUrl === "data:,") reject(new Error(`Data URL gambar tidak valid: ${section.elementId}`));
                                });
                                pdfReportContainer.appendChild(img);
                            } catch (e) {
                                console.error(`Error membuat gambar untuk ${section.elementId}:`, e);
                                const errorMsgEl = document.createElement('p');
                                errorMsgEl.textContent = `Gagal membuat gambar untuk grafik: ${section.title}.`;
                                errorMsgEl.style.color = 'red'; errorMsgEl.style.textAlign = 'center';
                                pdfReportContainer.appendChild(errorMsgEl);
                            }
                        } else if (messageElement && !messageElement.classList.contains('hidden')) {
                            const clonedMessage = messageElement.cloneNode(true);
                            clonedMessage.classList.remove('hidden'); clonedMessage.style.textAlign = 'center'; clonedMessage.style.padding = '20px';
                            pdfReportContainer.appendChild(clonedMessage);
                        } else {
                            const noDataMsg = document.createElement('p');
                            noDataMsg.textContent = `Data tidak tersedia atau grafik gagal dimuat: ${section.title}`;
                            noDataMsg.style.textAlign = 'center'; noDataMsg.style.padding = '20px';
                            pdfReportContainer.appendChild(noDataMsg);
                        }
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 300));

                    const canvas = await html2canvas(pdfReportContainer, {
                        scale: 1.5, 
                        useCORS: true,
                        logging: false, 
                        backgroundColor: '#ffffff', 
                        width: pdfReportContainer.scrollWidth, 
                        height: pdfReportContainer.scrollHeight, 
                        windowWidth: pdfReportContainer.scrollWidth, 
                        windowHeight: pdfReportContainer.scrollHeight
                    });
                    
                    if (document.body.contains(pdfReportContainer)) {
                        document.body.removeChild(pdfReportContainer);
                    }

                    const imgData = canvas.toDataURL('image/png', 0.92); 
                    const imgProps = pdf.getImageProperties(imgData); 
                    
                    const pageA4LandscapeWidthMm = pdf.internal.pageSize.getWidth();
                    const pageA4LandscapeHeightMm = pdf.internal.pageSize.getHeight();
                    const marginMm = 7; 

                    const availableWidthMm = pageA4LandscapeWidthMm - (2 * marginMm);
                    const availableHeightMm = pageA4LandscapeHeightMm - (2 * marginMm);

                    let scaledImgWidthMm = availableWidthMm;
                    let scaledImgHeightMm = (imgProps.height * scaledImgWidthMm) / imgProps.width;

                    if (scaledImgHeightMm > availableHeightMm) {
                        scaledImgHeightMm = availableHeightMm;
                        scaledImgWidthMm = (imgProps.width * scaledImgHeightMm) / imgProps.height;
                    }
                    
                    const xOffset = (pageA4LandscapeWidthMm - scaledImgWidthMm) / 2; 
                    const yOffset = marginMm+20; // Konten dimulai dari margin atas

                    pdf.addImage(imgData, 'PNG', xOffset, yOffset, scaledImgWidthMm, scaledImgHeightMm);
                }

                // Bagian Tabel Transaksi
                if (includeTransactionTable) {
                    if (!firstPageCreated) { 
                        pdf = new jsPDF('p', 'mm', 'a4'); 
                        firstPageCreated = true;
                    } else { 
                        pdf.addPage('a4', 'p'); 
                    }

                    const head = [['Tanggal', 'Jenis', 'Deskripsi', 'Kuantitas', 'Satuan', 'Harga Satuan', 'Kategori', 'Total']];
                    const body = transactions.map(trx => [
                        trx.tanggal,
                        trx.jenis,
                        trx.deskripsi,
                        trx.kuantitas !== undefined ? trx.kuantitas.toString() : '-',
                        trx.satuan || '-',
                        trx.hargaSatuan !== undefined ? formatRupiah(trx.hargaSatuan) : '-',
                        trx.kategori || '-',
                        formatRupiah(trx.total)
                    ]);

                    if (body.length > 0) {
                        pdf.autoTable({
                            head: head,
                            body: body,
                            startY: 15, 
                            theme: 'grid', 
                            styles: { fontSize: 7, cellPadding: 1.5, overflow: 'linebreak' },
                            headStyles: { fillColor: [41, 128, 185], textColor: 255, fontStyle: 'bold', fontSize: 8 },
                            columnStyles: {
                                0: { cellWidth: 20 }, 
                                1: { cellWidth: 20 }, 
                                2: { cellWidth: 'auto' }, 
                                3: { cellWidth: 15, halign: 'right' }, 
                                4: { cellWidth: 15 }, 
                                5: { cellWidth: 23, halign: 'right' }, 
                                6: { cellWidth: 22 }, 
                                7: { cellWidth: 23, halign: 'right' }  
                            },
                            margin: { top: 15, right: 10, bottom: 25, left: 10 }, 
                            didDrawPage: function (data) { 
                                pdf.setFontSize(8);
                                pdf.setTextColor(100);
                                pdf.text("Halaman " + pdf.internal.getNumberOfPages(), data.settings.margin.left, pdf.internal.pageSize.height - 10);
                            }
                        });
                    } else {
                         pdf.setFontSize(12);
                         pdf.text("Tidak ada data transaksi untuk ditampilkan dalam tabel.", 15, 15);
                    }
                }
                
                if (firstPageCreated) { 
                    const finalPageNum = pdf.internal.getNumberOfPages();
                    pdf.setPage(finalPageNum); 
                    
                    let yPosTimestamp = pdf.internal.pageSize.getHeight() - 15; 
                    
                    if (includeTransactionTable && transactions.length > 0 && pdf.lastAutoTable && pdf.lastAutoTable.finalY) {
                        if (pdf.lastAutoTable.finalY + 20 < pdf.internal.pageSize.getHeight() -10 ) { 
                            yPosTimestamp = pdf.lastAutoTable.finalY + 10;
                        } else { 
                            pdf.addPage(null, pdf.internal.pageSize.orientation === 'landscape' ? 'l' : 'p'); 
                            yPosTimestamp = 15; 
                        }
                    } else if (visualSectionsConfig.length > 0 && (!includeTransactionTable || transactions.length === 0)) {
                        yPosTimestamp = pdf.internal.pageSize.getHeight() - 15; 
                         if (pdf.internal.pageSize.orientation === 'portrait' && includeTransactionTable) {
                            yPosTimestamp = pdf.internal.pageSize.getHeight() - 15; 
                        }
                    }

                    pdf.setFontSize(9);
                    pdf.setTextColor(150); 
                    let xPosTimestamp = 10; 
                    if(pdf.internal.pageSize.orientation === 'landscape') {
                         xPosTimestamp = (pdf.internal.pageSize.getWidth() - pdf.getStringUnitWidth(`Laporan dibuat pada: ${new Date().toLocaleString('id-ID')}`) * pdf.getFontSize() / pdf.internal.scaleFactor) / 2;
                         if (xPosTimestamp < 10) xPosTimestamp = 10; 
                    }
                    pdf.text(`Laporan dibuat pada: ${new Date().toLocaleString('id-ID', { dateStyle: 'full', timeStyle: 'long' })}`, xPosTimestamp, yPosTimestamp);

                    pdf.save(`LaporanKeuanganBatagor_Kustom_${new Date().toISOString().slice(0,10).replace(/-/g,"")}.pdf`);
                    showModal("PDF Dibuat", "Laporan PDF kustom berhasil dibuat.", "success");
                }

            } catch (error) { 
                console.error("Error saat membuat PDF:", error);
                showModal("Error PDF", `Gagal membuat PDF: ${error.message}. Cek konsol untuk detail.`, "error");
            } finally {
                const finalActiveTabId = document.querySelector('.tab-link.active-tab')?.getAttribute('data-tab');
                if (finalActiveTabId !== originalActiveTabId && originalActiveTabId) {
                     const originalTabLink = document.querySelector(`.tab-link[data-tab="${originalActiveTabId}"]`);
                     if (originalTabLink) {
                        originalTabLink.click(); 
                     }
                }
                tombolUnduhPdf.disabled = false;
                if (messageModal.style.display === 'block' && modalTitleEl.textContent.includes("Mempersiapkan laporan PDF")) {
                    messageModal.style.display = 'none';
                }
            }
        }
        
        tombolUnduhPdf.addEventListener('click', generateFinancialReportPDF);

        // Initialize application
        async function initializeApp() {
            // Set default dates
            tanggalPengeluaranEl.value = today;
            tanggalPemasukanEl.value = today;
            deskripsiPemasukanEl.value = "Setoran"; // Default deskripsi pemasukan
            document.getElementById('currentYear').textContent = new Date().getFullYear();
            
            populateDeskripsiPengeluaran(); // Populate expense descriptions
            loadSettings(); // Load saved settings (URLs)
            await loadTransactionsFromSheet(); // Load transactions (from sheet or local storage)
            
            // Set default active tab
            const defaultTabId = 'pengeluaran';
            const defaultTabLink = document.querySelector(`.tab-link[data-tab="${defaultTabId}"]`);
            const defaultTabContent = document.getElementById(defaultTabId);

            tabLinks.forEach(link => {
                const tabName = link.getAttribute('data-tab');
                const tabContent = document.getElementById(tabName);
                if (link === defaultTabLink && defaultTabContent) {
                    link.classList.add('active-tab');
                    link.classList.add('active'); // For neumorph active button style
                    defaultTabContent.classList.add('active');
                } else if (tabContent) {
                    link.classList.remove('active-tab');
                    link.classList.remove('active');
                    tabContent.classList.remove('active');
                }
            });
            
            // Initial chart rendering with a slight delay to ensure layout is stable
            setTimeout(() => {
                renderCharts(); 
            }, 300); // Adjust delay if needed
        }

        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
